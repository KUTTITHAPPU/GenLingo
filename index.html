<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GenLingo - Fixed Photo Upload</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root { --blue: #0074D9; --navy: #001f3f; --green: #2ECC40; --red: #FF4136; --silver: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--silver); margin: 0; padding: 20px; }
        .main-card { max-width: 1000px; margin: 0 auto; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 5px 25px rgba(0,0,0,0.1); }
        
        /* RESTORED: Toolbar style from your original screenshot */
        .toolbar { 
            display: flex; flex-wrap: wrap; gap: 10px; align-items: center; 
            justify-content: center; background: #eef2f7; padding: 15px; 
            border-radius: 12px; margin-bottom: 25px; 
        }

        .btn { 
            padding: 10px 16px; border: none; border-radius: 6px; cursor: pointer; 
            font-weight: bold; color: white; background: var(--navy); 
            display: flex; align-items: center; gap: 8px; font-size: 14px;
        }
        .btn-translate { background: var(--blue); }
        .btn-reset { background: var(--red); }
        .btn-action { background: var(--green); padding: 6px 12px; font-size: 12px; }

        .manual-dropdown { padding: 9px; border-radius: 6px; border: 1px solid #ccc; min-width: 150px; font-weight: bold; }

        .grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .box-header { font-weight: 800; color: var(--navy); margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; font-size: 13px; }
        
        textarea, .mirror-div { 
            width: 100%; height: 400px; border-radius: 8px; border: 1px solid #ddd; 
            padding: 15px; font-size: 18px; box-sizing: border-box; background: white; 
            line-height: 1.6; resize: none; outline: none;
        }
        .mirror-div { position: relative; overflow-y: auto; border-color: var(--blue); }

        /* LOADING SPINNER */
        .loader { display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10; text-align: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--blue); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="main-card">
        <h1 style="text-align:center; color:var(--navy); margin-bottom:20px;">GenLingo</h1>

        <div class="toolbar">
            <label class="btn">üì∑ Photo <input type="file" id="imgFile" accept="image/*" hidden></label>
            <label class="btn">üìÇ PDF <input type="file" id="pdfFile" accept="application/pdf" hidden></label>
            <select id="userLang" class="manual-dropdown">
                <option value="hi">Hindi (‡§π‡§ø‡§®‡•ç‡§¶‡•Ä)</option>
                <option value="ml">Malayalam (‡¥Æ‡¥≤‡¥Ø‡¥æ‡¥≥‡¥Ç)</option>
                <option value="ta">Tamil (‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç)</option>
                <option value="te">Telugu (‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å)</option>
                <option value="kn">Kannada (‡≤ï‡≤®‡≥ç‡≤®‡≤°)</option>
            </select>
            <button class="btn btn-translate" onclick="startTranslation()">‚ú® Translate Now</button>
            <button class="btn btn-reset" onclick="location.reload()">Reset</button>
        </div>

        <div class="grid-container">
            <div>
                <div class="box-header">ENGLISH SOURCE</div>
                <textarea id="sourceInput" placeholder="Type or upload text..."></textarea>
            </div>

            <div style="position: relative;">
                <div class="box-header">
                    TRANSLATION
                    <div style="display:flex; gap:5px;">
                        <button class="btn btn-action" onclick="speakText()">üîä Speak</button>
                        <button class="btn btn-action" style="background:var(--red)" onclick="stopSpeech()">‚èπ Stop</button>
                        <button class="btn btn-action" style="background:var(--blue)" onclick="downloadPDF()">üì• PDF</button>
                    </div>
                </div>
                <div class="mirror-div" id="targetDiv">
                    <div id="loadingUI" class="loader">
                        <div class="spinner"></div>
                        <div style="margin-top:10px; color:var(--blue); font-weight:bold;">Processing...</div>
                    </div>
                    <span id="translatedContent">Translation appears here...</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
        const source = document.getElementById('sourceInput');
        const target = document.getElementById('translatedContent');
        const loader = document.getElementById('loadingUI');

        // --- FIXED PHOTO SCANNER (OCR) ---
        document.getElementById('imgFile').onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            source.value = "Scanning photo... Please wait.";
            
            try {
                // Using the latest Tesseract.recognize directly for better reliability
                const result = await Tesseract.recognize(file, 'eng', {
                    logger: m => console.log(m) 
                });
                source.value = result.data.text;
            } catch (err) {
                console.error(err);
                source.value = "Error: Could not read the image. Please try again.";
            }
        };

        // --- TRANSLATION ---
        async function startTranslation() {
            const text = source.value.trim();
            const lang = document.getElementById('userLang').value;
            if(!text) { alert("Please enter text first!"); return; }

            loader.style.display = "block";
            target.style.opacity = "0.3";

            try {
                const res = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=en|${lang}`);
                const data = await res.json();
                target.innerText = data.responseData.translatedText;
            } catch (e) {
                target.innerText = "Error connecting to engine.";
            } finally {
                loader.style.display = "none";
                target.style.opacity = "1";
            }
        }

        // --- PDF SCANNER ---
        document.getElementById('pdfFile').onchange = async (e) => {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = async function() {
                const pdf = await pdfjsLib.getDocument({data: new Uint8Array(this.result)}).promise;
                let fullText = "";
                for(let i=1; i<=pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    fullText += content.items.map(s => s.str).join(" ") + " ";
                }
                source.value = fullText;
            };
            reader.readAsArrayBuffer(file);
        };

        // --- VOICE & PDF DOWNLOAD ---
        function speakText() {
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(target.innerText);
            const langCode = document.getElementById('userLang').value;
            utterance.lang = langCode + "-IN";
            utterance.rate = 0.85;
            window.speechSynthesis.speak(utterance);
        }

        function stopSpeech() { window.speechSynthesis.cancel(); }

        function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text(doc.splitTextToSize(target.innerText, 180), 10, 20);
            doc.save("GenLingo_Translation.pdf");
        }
    </script>
</body>
</html>